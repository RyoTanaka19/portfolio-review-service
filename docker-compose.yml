version: "3.8"

services:
    app:
        build: .
        container_name: portfolio_app
        working_dir: /var/www/html
        volumes:
            - "./:/var/www/html"
            - "views_cache:/var/www/html/storage/framework/views"
            - "bootstrap_cache:/var/www/html/bootstrap/cache"
        env_file:
            - .env
        networks:
            - app-network
        depends_on:
            - db
        # appサービスはポート9000でPHP-FPMが動作するため、そのまま使用
        ports:
            - "9000:9000" # PHP-FPM用のポート設定はそのまま

    web:
        image: "nginx:alpine"
        container_name: portfolio_web
        volumes:
            - "./:/var/www/html"
            - "./nginx.conf:/etc/nginx/conf.d/default.conf"
        # Renderのポート設定に合わせて、nginxで環境変数PORTを使用
        ports:
            - "${PORT:-80}:80" # Renderで環境変数PORTが設定されていればそのポートを使い、設定されていなければポート80を使う
        networks:
            - app-network
        depends_on:
            - app

    db:
        image: "postgres:15"
        container_name: portfolio_db
        environment:
            POSTGRES_USER: laravel
            POSTGRES_PASSWORD: secret
            POSTGRES_DB: portfolio
        # PostgreSQLのポート設定はローカル環境に合わせて5433を公開
        ports:
            - "5433:5432"
        networks:
            - app-network
        volumes:
            - "db_data:/var/lib/postgresql/data"

networks:
    app-network:
        driver: bridge

volumes:
    db_data: {}
    views_cache: {}
    bootstrap_cache: {}
